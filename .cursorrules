# SmartDesk AI Rules & Context

You are an expert Python developer working on "SmartDesk", a Windows virtual desktop manager using PySide6 and Win32 APIs.

## üß† Core Principles
- **Stability First:** System-level calls (Win32) must be wrapped in try-except blocks. Crashes in background threads must not kill the main app.
- **Performance:** GUI operations (PySide6) must happen in the main thread. Heavy lifting (file I/O, system calls) goes to background threads.
- **Clean Code:** Follow PEP 8. Use type hints (`typing`) strictly. Docstrings for complex functions.
- **Communication:** Technical documentation and explanations must be in professional **German**.

## üèóÔ∏è Architecture & Features (v0.5.6+)
- **Target Platform:** Exclusively **Windows 10+**.
- **Start & Deployment:**
  - `start_smartdesk.bat`: Recommended launcher (starts Tray via `pythonw.exe`).
  - `main.py start-tray`: Manual CLI start.
  - `launch_gui.py`: Direct GUI start for debugging.
- **Persistent GUI Overlay:**
  - The hotkey overview (`gui_overview.py`) runs as a persistent background process managed by `BannerController`.
  - Communication happens via `stdin` commands: `SHOW`, `HIDE`, `QUIT`.
- **UI Styling & UX (CRITICAL):**
  - **Centralized Styling:** All styles must be defined in `src/smartdesk/ui/gui/style.qss`.
  - **No Inline Styles:** Do not use the `styleSheet` property in `.ui` files or `setStyleSheet()` in Python code.
  - **Dynamic Properties:** Use custom properties (e.g., `window_type="overview"`, `status="error"`) for state-based styling in CSS.
  - **Scroll Protection:** ComboBoxes and SpinBoxes must use an `eventFilter` to ignore wheel events when not focused (prevent accidental changes).
  - **Layout Patterns:** Place complex form content inside a `QScrollArea` within tabs. GroupBoxes should be styled flat/transparent (title matches page background).
- **Hotkey Logic:**
  - Triggers are "On-Release" (key up).
  - State Machine: `IDLE` -> `ARMED` -> `HOLDING` -> `SHOWING`.
  - **Robustness:** Listener callbacks (`on_press`, `on_release`) must be wrapped in `try-except` blocks to prevent thread crashes from unhandled exceptions in action handlers.
- **Desktop Switching Workflow:**
  - Sequence: Create Lock File -> Create Registry Backup -> Save Icons -> Update Registry -> Restart Windows Explorer -> Restore Icons/Wallpaper.

## ‚öôÔ∏è Technical Implementation Details
- **Threading & Locks:**
  - Use `threading.RLock` for services requiring recursive internal calls to avoid deadlocks.
  - Minimize lock contention: Copy shared resources within a lock, then release it before long iterations.
- **Performance (psutil):**
  - Iterate through `psutil.process_iter()` and stop early on matches instead of pre-generating large sets.
  - Use `psutil.wait_procs` for process termination checks.
- **File I/O:**
  - Use `file_lock` with exponential backoff (1ms to 100ms).
  - Cache raw JSON dictionaries instead of complex objects to avoid expensive deep copies.

## üß™ Testing & Development
- **Framework:** `pytest`. Run via `python -m pytest`.
- **Environment:** Must set `PYTHONPATH=src` and provide `APPDATA`.
- **Mocking:** Mock `win32*`, `ctypes`, `PySide6`, `PIL`, and `pynput` in `tests/conftest.py` for cross-platform support.
- **Headless GUI:** Set `QT_QPA_PLATFORM='offscreen'` for running PySide6 tests in CI.

## üìù Coding Style
- **Naming:** `snake_case` for variables/functions, `PascalCase` for classes, `UPPER_CASE` for constants.
- **Logging:** Use `smartdesk.shared.logging_config.get_logger`. **Never** use `print()` (crashes in `.pyw` mode).
- **Ruff:** Use `ruff` for linting and formatting.

## üöÄ Release Process
- Master version is defined in `src/smartdesk/__init__.py`.
- Sync `pyproject.toml` version manually.
- Document changes in `docs/releases/vX.X.X.md`.
